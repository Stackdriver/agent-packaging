#!/bin/bash

set -xe

sudo dnf -y install https://dev.mysql.com/get/mysql80-community-release-el8-1.noarch.rpm
sudo dnf --disablerepo=AppStream install -y mysql-community-server
sudo service mysqld start
m=$(grep 'temporary password' /var/log/mysqld.log)
pwd=${m##*:}

cat > config-user <<EOF
[client]
user=root
password=$pwd
EOF

sed -i 's/password= /password=/' config-user

mysql --defaults-extra-file=config-user -Bse "ALTER USER 'root'@'localhost' IDENTIFIED BY '123321'" --connect-expired-password

sed 's/^password=.*$/password=123321/' config-user

mysql --defaults-extra-file=config-user -Bse "CREATE DATABASE DATABASE_NAME;" --connect-expired-password

mysql --defaults-extra-file=config-user -Bse "CREATE USER 'STATS_USER'@'localhost' IDENTIFIED BY 'STATS_PASS';"

mysql --defaults-extra-file=config-user -Bse "GRANT REPLICATION CLIENT ON *.* TO 'STATS_USER'@'localhost';"

set +xe
