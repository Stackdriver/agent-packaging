#!/bin/bash

set -xe
sleep 3m

if [[ -f /etc/os-release ]]; then
  . /etc/os-release
fi

sudo yum -y install wget
sudo wget https://repo.mysql.com/mysql80-community-release-el${VERSION_ID}-1.noarch.rpm
sudo yum -y localinstall mysql80-community-release-el${VERSION_ID}-1.noarch.rpm

if [ ${VERSION_ID} == 8 ]; then  
  sudo yum -y module disable mysql
fi
sudo yum -y install mysql-community-server
sudo service mysqld start

m=$(sudo grep 'temporary password' /var/log/mysqld.log)
pwd=${m##*: }

cat > config-user <<EOF
[client]
user=root
password='$pwd'
EOF

mysql --defaults-extra-file=config-user -Bse "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'Ss123%321'" --connect-expired-password
sudo service mysqld status
set +xe
