#!/bin/bash

set -xe
sleep 3m

if [[ -f /etc/os-release ]]; then
  . /etc/os-release
fi
SUSE_VERSION=${VERSION%%-*}
mysql_pkg_name=''

if [ ${SUSE_VERSION} == 12 ]; then
  mysql_pkg_name=mysql80-community-release-sles12-1.noarch.rpm
elif [ ${SUSE_VERSION} == 15 ]; then
  mysql_pkg_name=mysql80-community-release-sl15-1.noarch.rpm
fi

sudo curl -LO https://dev.mysql.com/get/${mysql_pkg_name}
sudo rpm -Uvh ${mysql_pkg_name}
sudo rpm --import /etc/RPM-GPG-KEY-mysql
sudo zypper refresh
sudo zypper install -y mysql-community-server

if [ ${SUSE_VERSION} == 15 ]; then
  sudo zypper install -y libmariadb3
fi

sudo service mysql start

m=$(sudo grep 'temporary password' /var/log/mysql/mysqld.log)
pwd=${m##*: }

cat > config-user <<EOF
[client]
user=root
password='$pwd'
EOF

mysql --defaults-extra-file=config-user -Bse "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'Ss123%321'; FLUSH PRIVILEGES;" --connect-expired-password
sudo service mysql status

set +xe
